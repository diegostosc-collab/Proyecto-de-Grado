// Módulo 3: Frontend Dashboard - React.js
import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';
import { io } from 'socket.io-client';

const Dashboard = () => {
  const [realTimeData, setRealTimeData] = useState([]);
  const [historicalData, setHistoricalData] = useState([]);
  const [systemStatus, setSystemStatus] = useState('loading');

  useEffect(() => {
    // Conexión WebSocket para datos en tiempo real
    const socket = io('http://localhost:3000');
    
    socket.on('sensor-data', (data) => {
      setRealTimeData(prev => [...prev.slice(-50), data]);
    });

    socket.on('system-status', (status) => {
      setSystemStatus(status);
    });

    // Cargar datos históricos
    loadHistoricalData();

    return () => socket.disconnect();
  }, []);

  const loadHistoricalData = async () => {
    try {
      const response = await fetch('/api/analytics/power-generation?period=daily');
      const data = await response.json();
      setHistoricalData(data);
    } catch (error) {
      console.error('Error loading historical data:', error);
    }
  };

  const calculateMetrics = () => {
    if (realTimeData.length === 0) return {};
    
    const latest = realTimeData[realTimeData.length - 1];
    return {
      currentPower: latest.power,
      totalEnergy: realTimeData.reduce((sum, point) => sum + point.power, 0),
      efficiency: (latest.power / (latest.voltage * latest.current)) * 100
    };
  };

  const metrics = calculateMetrics();

  return (
    <div className="dashboard">
      <div className="status-header">
        <h1>Microrred Solar Vereda El Carmen</h1>
        <div className={`status-badge ${systemStatus}`}>
          {systemStatus.toUpperCase()}
        </div>
      </div>

      <div className="metrics-grid">
        <div className="metric-card">
          <h3>Potencia Actual</h3>
          <div className="metric-value">
            {metrics.currentPower ? metrics.currentPower.toFixed(2) : '0'} W
          </div>
        </div>

        <div className="metric-card">
          <h3>Energía Total</h3>
          <div className="metric-value">
            {metrics.totalEnergy ? (metrics.totalEnergy / 1000).toFixed(2) : '0'} kWh
          </div>
        </div>

        <div className="metric-card">
          <h3>Eficiencia</h3>
          <div className="metric-value">
            {metrics.efficiency ? metrics.efficiency.toFixed(1) : '0'}%
          </div>
        </div>
      </div>

      <div className="charts-section">
        <div className="chart-card">
          <h3>Potencia en Tiempo Real</h3>
          <LineChart width={600} height={300} data={realTimeData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="timestamp" />
            <YAxis />
            <Tooltip />
            <Legend />
            <Line type="monotone" dataKey="power" stroke="#8884d8" />
          </LineChart>
        </div>

        <div className="chart-card">
          <h3>Generación Histórica</h3>
          <LineChart width={600} height={300} data={historicalData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="_id" />
            <YAxis />
            <Tooltip />
            <Legend />
            <Line type="monotone" dataKey="totalPower" stroke="#82ca9d" />
          </LineChart>
        </div>
      </div>
    </div>
  );
};

export default Dashboard;
